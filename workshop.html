<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Dashboard | Weeecycle.net</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&family=Roboto+Condensed:ital,wght@0,300;0,400;0,700;1,400&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { dark: '#050511', blue: '#0B0B3B', orange: '#FF8000', green: '#10B981', red: '#EF4444' }
                    },
                    fontFamily: { display: ['Teko', 'sans-serif'], body: ['Roboto Condensed', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .kanban-col {
            min-height: 500px;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
    </style>
</head>

<body class="bg-black text-gray-200 font-body antialiased flex h-screen overflow-hidden relative">
    <style>
        .kanban-col {
            min-height: 500px;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            min-height: 80px;
            padding: 4px;
            background: #151535;
            border: 1px solid #1f2937;
            border-radius: 4px;
            position: relative;
        }

        .calendar-day:hover {
            background: #1a1a40;
            border-color: #FF8000;
        }

        .calendar-day.today {
            border-color: #FF8000;
            background: #1a1a3a;
        }

        .day-num {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            color: #6b7280;
        }

        .job-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #FF8000;
            display: inline-block;
            margin-right: 2px;
        }
    </style>

    <!-- Auth Check -->
    <!-- Auth Check -->
    <script>
        const user = localStorage.getItem('workshop_user');
        if (!user) {
            window.location.href = 'login.html';
        }
    </script>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/80 z-40 hidden md:hidden glass-blur"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-[#050511] border-r border-gray-800 flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:static md:flex-shrink-0">
        <!-- Brand -->
        <div class="h-20 flex flex-col justify-center px-6 border-b border-gray-800 relative">
            <div class="flex flex-col">
                <span class="font-display font-bold text-2xl tracking-widest text-white leading-none">WEEECYCLE<span
                        class="text-brand-orange">.NET</span></span>
                <span class="font-body text-[10px] text-brand-orange uppercase tracking-[0.2em]">Mechanic Portal</span>
            </div>
            <button onclick="toggleSidebar()" class="absolute right-4 top-1/2 -translate-y-1/2 md:hidden text-gray-400">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <div id="api-status"
                class="mt-2 text-xs font-bold text-gray-600 flex items-center gap-1 uppercase tracking-wider">
                <div class="w-2 h-2 bg-gray-600 rounded-full"></div> Connecting...
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 flex flex-col p-4 gap-2 overflow-y-auto">
            <button onclick="switchTab('dashboard'); closeSidebarMobile()" id="nav-dashboard"
                class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg bg-brand-orange text-white hover:bg-orange-600 transition text-left">
                <i class="fa-solid fa-gauge-high w-6 text-center"></i>
                <span class="font-display font-bold uppercase tracking-wide">Dashboard</span>
            </button>
            <button onclick="switchTab('jobs'); closeSidebarMobile()" id="nav-jobs"
                class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition text-left">
                <i class="fa-solid fa-list-check w-6 text-center"></i>
                <span class="font-display font-bold uppercase tracking-wide">Job Board</span>
            </button>
            <button onclick="switchTab('inventory'); closeSidebarMobile()" id="nav-inventory"
                class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition text-left">
                <i class="fa-solid fa-boxes-stacked w-6 text-center"></i>
                <span class="font-display font-bold uppercase tracking-wide">Inventory</span>
            </button>
            <button onclick="switchTab('contacts'); closeSidebarMobile()" id="nav-contacts"
                class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition text-left">
                <i class="fa-solid fa-address-book w-6 text-center"></i>
                <span class="font-display font-bold uppercase tracking-wide">Contacts</span>
            </button>
        </nav>

        <!-- User / Logout -->
        <div class="p-4 border-t border-gray-800">
            <div class="flex items-center gap-3 px-4 py-3 mb-2">
                <div class="w-8 h-8 rounded-full bg-brand-orange text-white flex items-center justify-center font-bold">
                    M</div>
                <div>
                    <div class="text-sm font-bold text-white">Mechanic</div>
                    <div class="text-xs text-brand-orange">Online</div>
                </div>
            </div>
            <!-- Bottom Actions -->
            <div class="mt-auto pt-6 border-t border-gray-800 space-y-2">
                <button onclick="document.getElementById('settings-modal').showModal(); closeSidebarMobile()"
                    class="w-full flex items-center gap-3 px-4 py-2 rounded text-gray-400 hover:text-white hover:bg-white/5 transition text-sm uppercase font-bold">
                    <i class="fa-solid fa-cog w-6 text-center"></i> Settings
                </button>
                <button onclick="logout()"
                    class="w-full flex items-center gap-3 px-4 py-2 rounded text-red-400 hover:bg-red-500/10 transition text-sm uppercase font-bold">
                    <i class="fa-solid fa-right-from-bracket w-6 text-center"></i> Logout
                </button>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-black">

        <!-- Mobile Header -->
        <div
            class="md:hidden h-16 bg-[#050511] border-b border-gray-800 flex items-center px-4 justify-between flex-shrink-0 z-30">
            <span class="font-display font-bold text-xl tracking-widest text-white leading-none">WEEECYCLE</span>
            <button onclick="toggleSidebar()" class="text-white p-2">
                <i class="fa-solid fa-bars text-2xl"></i>
            </button>
        </div>

        <!-- Views Container -->
        <div class="flex-1 relative overflow-hidden">

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="absolute inset-0 p-4 md:p-6 overflow-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto h-full">

                    <!-- Left Column: Action Required & Recents -->
                    <div class="lg:col-span-1 space-y-8 flex flex-col">

                        <!-- Action Required -->
                        <div class="bg-[#0B0B2B] border border-gray-800 rounded-xl p-6 flex-1 flex flex-col">
                            <h2
                                class="font-display font-bold text-3xl text-white uppercase mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-brand-orange">notification_important</span>
                                Action Required
                            </h2>
                            <div id="action-required-list" class="space-y-4 overflow-y-auto flex-1 pr-2 max-h-[400px]">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Recents -->
                        <div class="bg-[#0B0B2B] border border-gray-800 rounded-xl p-6 h-fit">
                            <h2 class="font-display font-bold text-2xl text-white uppercase mb-4">Recent Activity</h2>
                            <ul id="recents-list" class="space-y-3 text-sm text-gray-400">
                                <!-- Populated by JS -->
                            </ul>
                        </div>

                    </div>

                    <!-- Right Column: Agenda & Analytics -->
                    <div class="lg:col-span-2 flex flex-col gap-6 h-full">

                        <!-- Top: Agenda (Day View) -->
                        <div class="bg-[#0B0B2B] border border-gray-800 rounded-xl p-6 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h2 class="font-display font-bold text-3xl text-white uppercase">Agenda</h2>
                                    <p id="agenda-date" class="text-brand-orange font-bold uppercase text-lg">Today</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="changeDay(-1)"
                                        class="w-8 h-8 rounded bg-gray-800 hover:bg-gray-700 text-white flex items-center justify-center transition"><i
                                            class="fa-solid fa-chevron-left"></i></button>
                                    <button onclick="resetDay()"
                                        class="px-3 py-1 rounded bg-brand-orange hover:bg-orange-600 text-white text-xs font-bold uppercase transition">Today</button>
                                    <button onclick="changeDay(1)"
                                        class="w-8 h-8 rounded bg-gray-800 hover:bg-gray-700 text-white flex items-center justify-center transition"><i
                                            class="fa-solid fa-chevron-right"></i></button>
                                </div>
                            </div>

                            <!-- Agenda List -->
                            <div id="agenda-list" class="flex-1 overflow-y-auto space-y-3 pr-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Bottom: Metrics (Pie Chart + Hours) -->
                        <div class="h-64">


                            <!-- Shop Info -->
                            <div class="bg-[#0B0B2B] border border-gray-800 rounded-xl p-6 relative">
                                <h3 class="font-display font-bold text-lg text-white uppercase mb-4">Shop Status</h3>
                                <div class="text-left">
                                    <h4 class="font-bold text-brand-orange uppercase text-xs tracking-wider mb-1">Hours
                                        of
                                        Operation</h4>
                                    <p id="shop-hours" class="text-gray-400 text-sm whitespace-pre-line mb-4">Mon-Fri:
                                        9am -
                                        5pm\nSat: 10am - 2pm\nSun: Closed</p>
                                    <button onclick="editShopHours()"
                                        class="text-xs bg-gray-800 hover:bg-white hover:text-black text-gray-400 px-3 py-1 rounded transition">Edit
                                        Hours</button>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <!-- JOB BOARD VIEW -->
            <div id="view-jobs" class="hidden absolute inset-0 p-4 md:p-6 overflow-x-auto overflow-y-hidden flex gap-6">
                <!-- Columns generated by JS -->
                <div class="flex gap-6 h-full min-w-max" id="kanban-board">
                    <!-- Columns: Booked In, Waiting Approval, Waiting Parts, Working On, Bike Ready, Completed -->
                </div>
            </div>

            <!-- INVENTORY VIEW -->
            <div id="view-inventory" class="hidden absolute inset-0 p-4 md:p-6 overflow-auto bg-brand-dark">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">

                    <!-- My Bench Inventory -->
                    <div class="lg:col-span-2 bg-[#0B0B2B] border border-gray-800 rounded-xl p-6 h-fit">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="font-display font-bold text-3xl text-white uppercase">My Bench Stock</h2>
                            <button onclick="addItem()"
                                class="bg-brand-orange text-white px-3 py-1 rounded text-sm uppercase font-bold hover:bg-orange-600 transition">+
                                Add Item</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-gray-900 text-gray-200 uppercase font-display text-lg">
                                    <tr>
                                        <th class="p-3 rounded-tl-lg">Item Name</th>
                                        <th class="p-3">Qty</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3 rounded-tr-lg text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body" class="divide-y divide-gray-800">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Amazon Restock -->
                    <div class="bg-[#0B0B2B] border border-gray-800 rounded-xl p-6 h-fit">
                        <h2 class="font-display font-bold text-3xl text-white uppercase mb-6">Quick Restock</h2>
                        <div class="space-y-4">
                            <a href="https://amzn.to/4bc5L8S" target="_blank"
                                class="block p-4 border border-gray-700 rounded hover:border-brand-orange transition group bg-[#151535]">
                                <div class="flex items-center gap-4">
                                    <div class="bg-white p-2 rounded w-12 h-12 flex items-center justify-center"><img
                                            src="images/Tri-Flow-Lube.png" class="max-h-full"></div>
                                    <div>
                                        <div class="font-bold text-white uppercase group-hover:text-brand-orange">
                                            Tri-Flow
                                            Lube</div>
                                        <div class="text-xs text-gray-500">Premium Lubricant</div>
                                    </div>
                                </div>
                            </a>
                            <a href="https://amzn.to/4qckoy1" target="_blank"
                                class="block p-4 border border-gray-700 rounded hover:border-brand-orange transition group bg-[#151535]">
                                <div class="flex items-center gap-4">
                                    <div class="bg-white p-2 rounded w-12 h-12 flex items-center justify-center"><img
                                            src="images/orange bartape.png" class="max-h-full"></div>
                                    <div>
                                        <div class="font-bold text-white uppercase group-hover:text-brand-orange">Orange
                                            Bar
                                            Tape</div>
                                        <div class="text-xs text-gray-500">Grip & Style</div>
                                    </div>
                                </div>
                            </a>
                            <button onclick="addAmazonItem()"
                                class="w-full py-2 border border-gray-600 text-gray-400 hover:text-brand-orange hover:border-brand-orange transition uppercase font-bold text-xs rounded mb-4">+
                                Add Amazon Product</button>
                            <button onclick="window.open('stock.html', '_blank')"
                                class="w-full py-3 border border-dashed border-gray-600 text-gray-400 hover:text-white hover:border-brand-orange transition uppercase font-bold text-sm rounded mt-4">Browse
                                Stockroom</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- CONTACTS VIEW -->
        <div id="view-contacts" class="hidden absolute inset-0 p-4 md:p-8 overflow-auto bg-brand-dark">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-8">
                    <h2 class="font-display font-bold text-3xl md:text-4xl text-white uppercase">Contacts</h2>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <div class="relative w-full md:w-auto">
                            <i
                                class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                            <input type="text" id="contact-search" placeholder="Search customers..."
                                onkeyup="renderContacts()"
                                class="bg-[#050511] border border-gray-700 text-white pl-10 pr-4 py-2 rounded w-full md:w-64 focus:border-brand-orange focus:outline-none">
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="startWalkInJob()"
                                class="flex-1 md:flex-none bg-brand-orange hover:bg-orange-600 text-white font-bold uppercase tracking-wider px-4 py-2 rounded transition flex items-center justify-center gap-2 whitespace-nowrap">
                                <i class="fa-solid fa-plus-circle"></i> New Job
                            </button>
                            <!-- Import/Export -->
                            <div class="flex gap-2 flex-1 md:flex-none">
                                <input type="file" id="csv-upload" accept=".csv" class="hidden"
                                    onchange="processCSVImport(this)">
                                <button onclick="document.getElementById('csv-upload').click()"
                                    class="flex-1 bg-[#151535] hover:bg-gray-700 text-gray-300 hover:text-white font-bold uppercase tracking-wider px-4 py-2 rounded transition flex items-center justify-center gap-2 text-sm border border-gray-700">
                                    <i class="fa-solid fa-file-import"></i> Import
                                </button>
                                <button onclick="exportContactsCSV()"
                                    class="flex-1 bg-[#151535] hover:bg-gray-700 text-gray-300 hover:text-white font-bold uppercase tracking-wider px-4 py-2 rounded transition flex items-center justify-center gap-2 text-sm border border-gray-700">
                                    <i class="fa-solid fa-file-export"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-[#0B0B2B] border border-gray-800 rounded-xl overflow-x-auto">
                    <table class="w-full text-left">
                        <thead
                            class="bg-[#151535] text-brand-orange font-bold uppercase text-sm border-b border-gray-700">
                            <tr>
                                <th class="p-4 w-10 text-center"><input type="checkbox" id="select-all-contacts"
                                        onclick="toggleAllContacts()"></th>
                                <th class="p-4">Customer Name</th>
                                <th class="p-4">Email</th>
                                <th class="p-4">Phone</th>
                                <th class="p-4">Total Jobs</th>
                                <th class="p-4">Last Seen</th>
                                <th class="p-4 text-right">
                                    <button id="delete-selected-btn" onclick="deleteSelectedContacts()"
                                        class="hidden text-red-500 hover:text-white bg-red-900/20 hover:bg-red-600 px-3 py-1 rounded text-xs transition"><i
                                            class="fa-solid fa-trash mr-1"></i> Delete Selected</button>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body" class="text-gray-300 divide-y divide-gray-800">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        </div> <!-- End Absolute Wrapper -->
        </div> <!-- End Views Container -->
    </main> <!-- End Main -->

    <!-- Modals -->
    <!-- JOB HISTORY MODAL -->
    <dialog id="job-history-modal"
        class="bg-[#151535] text-white rounded-xl shadow-2xl p-0 w-full max-w-2xl backdrop:bg-black/80">
        <div class="flex justify-between items-center p-6 border-b border-gray-700">
            <h3 class="font-display font-bold text-2xl uppercase tracking-wider text-white"><span
                    id="history-customer-name" class="text-brand-orange"></span> History</h3>
            <button onclick="document.getElementById('job-history-modal').close()"
                class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div class="p-6 overflow-y-auto max-h-[60vh] space-y-4" id="history-list">
            <!-- Populated via JS -->
        </div>
    </dialog>

    <!-- existing edit modal -->
    <dialog id="new-job-modal"
        class="bg-[#1a1a3d] text-white rounded-lg shadow-2xl p-0 backdrop:bg-black/80 w-full max-w-md border border-gray-700">
        <div class="bg-[#0B0B2B] p-4 border-b border-gray-700 flex justify-between items-center">
            <h2 class="font-display font-bold text-2xl uppercase tracking-wider text-green-500"><i
                    class="fa-solid fa-plus-circle mr-2"></i> New Job</h2>
            <button onclick="document.getElementById('new-job-modal').close()"
                class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="p-6 space-y-4">
            <input type="hidden" id="new-job-contact-id">

            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Customer Name</label>
                    <input type="text" id="new-job-name"
                        class="w-full bg-[#0B0B2B] text-white rounded border border-gray-700 p-2 focus:border-brand-orange focus:outline-none placeholder-gray-600"
                        placeholder="Enter Name">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Email</label>
                        <input type="email" id="new-job-email"
                            class="w-full bg-[#0B0B2B] text-white rounded border border-gray-700 p-2 focus:border-brand-orange focus:outline-none placeholder-gray-600"
                            placeholder="Optional">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Phone</label>
                        <input type="tel" id="new-job-phone"
                            class="w-full bg-[#0B0B2B] text-white rounded border border-gray-700 p-2 focus:border-brand-orange focus:outline-none placeholder-gray-600"
                            placeholder="Optional">
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Bike Model</label>
                <input type="text" id="new-job-bike"
                    class="w-full bg-[#0B0B2B] text-white rounded border border-gray-700 p-2 focus:border-green-500 focus:outline-none placeholder-gray-600"
                    placeholder="e.g. Trek Domane">
            </div>

            <div>
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Service Type</label>
                <select id="new-job-service" onchange="toggleCustomService()"
                    class="w-full bg-[#0B0B2B] text-white p-3 rounded border border-gray-700 focus:border-brand-orange outline-none mb-3 font-mono text-sm">
                    <option value="Safety Check">Safety Check</option>
                    <option value="The Tune-Up">The Tune-Up</option>
                    <option value="Overhaul">Overhaul</option>
                    <option value="Dream Build">Dream Build</option>
                    <option value="A La Carte">A La Carte</option>
                </select>
                <input type="text" id="new-job-custom-service" placeholder="Specify Service (e.g. Wheel True)"
                    class="w-full bg-[#0B0B2B] text-white p-3 rounded border border-gray-700 focus:border-brand-orange outline-none mb-3 font-mono text-sm hidden">
            </div>
        </div>
        <div class="p-4 bg-[#0B0B2B] border-t border-gray-700 flex justify-end gap-2">
            <button onclick="document.getElementById('new-job-modal').close()"
                class="px-4 py-2 text-gray-400 hover:text-white font-bold transition">Cancel</button>
            <button onclick="confirmNewJob()"
                class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded font-bold uppercase tracking-wider transition shadow-lg shadow-green-900/50">Book
                In</button>
        </div>
    </dialog>

    <dialog id="edit-contact-modal"
        class="bg-[#0B0B2B] text-white rounded-xl shadow-2xl p-0 w-full max-w-lg backdrop:bg-black/80 border border-gray-700">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-[#151535]">
            <h3 class="font-display font-bold text-2xl uppercase">Edit Contact</h3>
            <button onclick="document.getElementById('edit-contact-modal').close()"
                class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="p-6 space-y-4">
            <input type="hidden" id="edit-contact-id">
            <div>
                <label class="block text-brand-orange text-sm font-bold uppercase mb-1">Name</label>
                <input type="text" id="edit-contact-name"
                    class="w-full bg-[#050511] border border-gray-700 rounded px-3 py-2 text-white focus:border-brand-orange focus:outline-none">
            </div>
            <div>
                <label class="block text-brand-orange text-sm font-bold uppercase mb-1">Email</label>
                <input type="text" id="edit-contact-email"
                    class="w-full bg-[#050511] border border-gray-700 rounded px-3 py-2 text-white focus:border-brand-orange focus:outline-none">
            </div>
            <div>
                <label class="block text-brand-orange text-sm font-bold uppercase mb-1">Phone</label>
                <input type="text" id="edit-contact-phone"
                    class="w-full bg-[#050511] border border-gray-700 rounded px-3 py-2 text-white focus:border-brand-orange focus:outline-none">
            </div>
        </div>
        <div class="p-6 border-t border-gray-700 flex justify-end gap-3 bg-[#151535]">
            <button onclick="document.getElementById('edit-contact-modal').close()"
                class="text-gray-400 hover:text-white font-bold uppercase text-sm px-4 py-2">Cancel</button>
            <button onclick="saveContact()"
                class="bg-brand-orange hover:bg-orange-600 text-white font-bold uppercase px-6 py-2 rounded transition">Save
                Changes</button>
        </div>
    </dialog>

    <dialog id="job-sheet-modal"
        class="bg-[#0B0B2B] text-white rounded-xl shadow-2xl p-0 w-full max-w-4xl backdrop:bg-black/80 border border-gray-700">
        <div class="flex h-[80vh] flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-700 flex justify-between items-start bg-[#151535]">
                <div>
                    <h2 id="modal-customer" class="font-display font-bold text-3xl uppercase text-white">Customer Name
                    </h2>
                    <div class="flex gap-4 mt-2 text-sm text-gray-400">
                        <span id="modal-bike"><i class="fa-solid fa-bicycle mr-1"></i> Bike Model</span>
                        <span id="modal-service" class="text-brand-orange font-bold uppercase"><i
                                class="fa-solid fa-screwdriver-wrench mr-1"></i> Service Type</span>
                    </div>
                </div>
                <button onclick="closeJobSheet()"
                    class="text-gray-400 hover:text-white px-3 py-1 rounded hover:bg-white/10 transition"><i
                        class="fa-solid fa-xmark text-2xl"></i></button>
            </div>

            <!-- Body -->
            <div class="flex-grow overflow-y-auto p-8 space-y-8">
                <!-- Parts & Extras Section -->
                <div id="modal-parts" class="space-y-4 border-b border-gray-700 pb-8">
                    <!-- Populated via JS -->
                </div>

                <!-- Checklist items injected here -->
                <div id="modal-checklist" class="space-y-8"></div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-700 bg-[#151535] flex justify-end">
                <button onclick="closeJobSheet()"
                    class="bg-brand-orange hover:bg-orange-600 text-white font-bold uppercase py-2 px-6 rounded transition">Save
                    & Close</button>
            </div>
        </div>
    </dialog>

    <!-- Settings Modal -->
    <dialog id="settings-modal"
        class="bg-[#151525] text-white p-0 rounded-xl shadow-2xl backdrop:bg-black/80 w-full max-w-md border border-gray-700">
        <div class="border-b border-gray-700 p-4 flex justify-between items-center bg-[#0f0f1f]">
            <h3 class="font-display font-bold text-xl uppercase tracking-wider text-brand-orange"><i
                    class="fa-solid fa-cog mr-2"></i> Settings</h3>
            <button onclick="document.getElementById('settings-modal').close()"
                class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="p-6 space-y-6">
            <h4 class="font-bold text-lg border-b border-gray-700 pb-2">Change Password</h4>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider font-bold text-gray-400 mb-1">Current
                        Password</label>
                    <input type="password" id="current-password"
                        class="w-full bg-[#0a0a1a] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-wider font-bold text-gray-400 mb-1">New
                        Password</label>
                    <input type="password" id="new-password"
                        class="w-full bg-[#0a0a1a] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none">
                </div>
            </div>
            <div id="password-msg" class="text-center text-sm hidden"></div>

            <div class="border-t border-gray-700 pt-4 mt-2">
                <h4 class="font-bold text-lg border-b border-gray-700 pb-2 mb-4">Database Tools</h4>
                <button onclick="mergeDuplicates()"
                    class="w-full bg-[#1e1e3f] hover:bg-brand-orange text-white py-2 rounded border border-gray-600 transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-users-viewfinder"></i> Cleanup Duplicate Contacts
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">Merges duplicates by email and removes redundant
                    records.</p>
            </div>
        </div>
        <div class="bg-[#0f0f1f] p-4 flex justify-end gap-2 rounded-b-xl border-t border-gray-700">
            <button onclick="changePassword()"
                class="bg-brand-orange hover:bg-orange-600 text-white font-bold uppercase tracking-wider px-6 py-2 rounded transition">Update
                Password</button>
        </div>
    </dialog>

    <!-- Add Contact Modal -->
    <dialog id="add-contact-modal"
        class="bg-[#151525] text-white p-0 rounded-xl shadow-2xl backdrop:bg-black/80 w-full max-w-md border border-gray-700">
        <div class="border-b border-gray-700 p-4 flex justify-between items-center bg-[#0f0f1f]">
            <h3 class="font-display font-bold text-xl uppercase tracking-wider text-brand-orange"><i
                    class="fa-solid fa-user-plus mr-2"></i> Add Customer</h3>
            <button onclick="document.getElementById('add-contact-modal').close()"
                class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-xs uppercase tracking-wider font-bold text-gray-400 mb-1">Full Name</label>
                <input type="text" id="add-contact-name"
                    class="w-full bg-[#0a0a1a] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none"
                    placeholder="e.g. John Doe">
            </div>
            <div>
                <label class="block text-xs uppercase tracking-wider font-bold text-gray-400 mb-1">Email</label>
                <input type="email" id="add-contact-email"
                    class="w-full bg-[#0a0a1a] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none"
                    placeholder="john@example.com">
            </div>
            <div>
                <label class="block text-xs uppercase tracking-wider font-bold text-gray-400 mb-1">Phone</label>
                <input type="tel" id="add-contact-phone"
                    class="w-full bg-[#0a0a1a] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none"
                    placeholder="(555) 123-4567">
            </div>
        </div>
        <div class="bg-[#0f0f1f] p-4 flex justify-end gap-2 rounded-b-xl border-t border-gray-700">
            <button onclick="document.getElementById('add-contact-modal').close()"
                class="px-4 py-2 text-gray-400 hover:text-white transition">Cancel</button>
            <button onclick="saveNewContact()"
                class="bg-brand-orange hover:bg-orange-600 text-white font-bold uppercase tracking-wider px-6 py-2 rounded transition">Save
                Contact</button>
        </div>
    </dialog>

    <!-- Inventory Selection Modal -->
    <dialog id="inventory-selection-modal"
        class="bg-[#151525] text-white p-0 rounded-xl shadow-2xl backdrop:bg-black/80 w-full max-w-md border border-gray-700">
        <div class="border-b border-gray-700 p-4 flex justify-between items-center bg-[#0f0f1f]">
            <h3 class="font-display font-bold text-xl uppercase tracking-wider text-brand-orange"><i
                    class="fa-solid fa-boxes-stacked mr-2"></i> Select Part</h3>
            <button onclick="cancelPartSelection()" class="text-gray-400 hover:text-white transition"><i
                    class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-gray-400">Select the part used for this job to deduct from inventory.</p>
            <div>
                <label class="block text-xs uppercase tracking-wider font-bold text-gray-400 mb-1">Part</label>
                <select id="inventory-select-dropdown"
                    class="w-full bg-[#0a0a1a] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none">
                    <!-- Populated by JS -->
                </select>
            </div>
        </div>
        <div class="bg-[#0f0f1f] p-4 flex justify-end gap-2 rounded-b-xl border-t border-gray-700">
            <button onclick="cancelPartSelection()"
                class="px-4 py-2 text-gray-400 hover:text-white transition">Cancel</button>
            <button onclick="confirmPartSelection()"
                class="bg-brand-orange hover:bg-orange-600 text-white font-bold uppercase tracking-wider px-6 py-2 rounded transition">Confirm
                & Move</button>
        </div>
    </dialog>

    <script>
        // --- MOBILE NAV ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar.classList.contains('-translate-x-full')) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Close
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function closeSidebarMobile() {
            if (window.innerWidth < 768) { // md breakpoint
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
        }

        // --- DATA & STATE ---
        const COLUMNS = [
            { id: 'booked', title: 'Booked In', color: 'border-l-4 border-gray-400' },
            { id: 'approval', title: 'Waiting Approval', color: 'border-l-4 border-yellow-500' },
            { id: 'parts', title: 'Waiting Parts', color: 'border-l-4 border-blue-500' },
            { id: 'working', title: 'Working On', color: 'border-l-4 border-brand-orange' },
            { id: 'ready', title: 'Bike Ready', color: 'border-l-4 border-green-500' },
            { id: 'completed', title: 'Completed', color: 'border-l-4 border-gray-700 opacity-60' }
        ];

        // CHECKLIST DATA
        const SERVICE_PRICES = {
            "Safety Check": 60,
            "The Tune-Up": 120,
            "Overhaul": 250,
            "Dream Build": 400,
            "A La Carte": 0 // Calculated manually or per item
        };

        const SERVICE_CHECKLISTS = {
            "Safety Check": {
                "Frame/Fork": [
                    "Inspect frame for damage/wear including dropouts, main tubes, seat clamp area, bottle cage and accessory mounting points",
                    "Inspect fork for damage/wear including dropouts, main tubes, crown, steerer tube and accessory mounting points"
                ],
                "Handlebar/Headset/Stem": [
                    "Inspect headset for wear/corrosion",
                    "Inspect handlebar for wear/damage",
                    "Inspect stem for wear, verify straight",
                    "Inspect handlebar tape/grips for wear/damage"
                ],
                "Wheels/Tires": [
                    "Inspect spokes and rim for wear/damage",
                    "Inspect tires for condition and wear"
                ],
                "Brakes": [
                    "Inspect condition of hose/cable",
                    "Inspect caliper",
                    "Inspect brake rotor for wear/damage/torque"
                ],
                "Bottom Bracket/Cranks": [
                    "Inspect chain rings/crank arms/spindle for wear/damage"
                ],
                "Pedals": [
                    "Inspect pedal body for wear/damage"
                ],
                "Drivetrain/Gears": [
                    "Inspect chain for wear/damage",
                    "Inspect front derailleur",
                    "Inspect rear derailleur",
                    "Inspect cassette for wear/damage and torque"
                ],
                "Saddle": [
                    "Check saddle for wear/damage",
                    "Inspect seat post and clamp",
                    "Insect saddle rails/clamps"
                ],
                "Accessories": [
                    "Ensure any accessories are safe/secure"
                ]
            },
            "The Tune-Up": {
                "Frame/Fork": [
                    "Inspect frame for damage/wear including dropouts, main tubes, seat clamp area, bottle cage and accessory mounting points",
                    "Inspect fork for damage/wear including dropouts, main tubes, crown, steerer tube and accessory mounting points",
                    "<b>Inspect / adjust suspension linkages (if required)</b>",
                    "<b>Suspension forks, clean/inspect seals and upper tubes. Check for function</b>"
                ],
                "Handlebar/Headset/Stem": [
                    "Inspect headset for wear/corrosion, <b>adjust</b>",
                    "Inspect handlebar for wear/damage <b>adjust</b>",
                    "Inspect stem for wear, <b>straight the stem</b>",
                    "Inspect handlebar tape/grips for wear/damage",
                    "<b>Change handlebar tape (if damage, purchase extra)</b>"
                ],
                "Wheels/Tires": [
                    "Inspect spokes and rim for wear/damage, <b>change spokes (if necessary, material extra cost)</b>",
                    "Inspect tires for condition and wear",
                    "Inspect tubeless system, top-up or replace consumables as appropriate"
                ],
                "Brakes": [
                    "Inspect condition of hose/cable, <b>change</b>",
                    "Inspect caliper for correct function including clean/lube pistons",
                    "Inspect brake rotor for wear/damage/torque",
                    "<b>Inspect condition of lever, including main body, blades and position. Adjust if required.</b>",
                    "<b>Adjust brake, ensure correct function including no rub and appropriate bite-point</b>"
                ],
                "Bottom Bracket/Cranks": [
                    "Inspect chain rings/crank arms/spindle for wear/damage",
                    "Inspect bottom bracket torque, ensure free rotation of bearings"
                ],
                "Pedals": [
                    "Inspect pedal body for wear/damage",
                    "<b>Ensure smooth rotation of pedal bearings and check for play</b>"
                ],
                "Drivetrain/Gears": [
                    "Inspect chain for wear/damage, <b>lubricate</b>",
                    "Inspect front derailleur",
                    "Inspect rear derailleur",
                    "<b>Index front derailleur</b>",
                    "<b>Index rear derailleur</b>",
                    "Inspect cassette for wear/damage and torque",
                    "<b>Ensure derailleur hanger is straight and secure</b>",
                    "<b>Set front derailleur position/height</b>"
                ],
                "Saddle": [
                    "Check saddle for wear/damage",
                    "Inspect seat post and clamp",
                    "Insect saddle rails/clamps",
                    "<b>Grease grip as appropriate</b>"
                ],
                "Accessories": [
                    "Ensure any accessories are safe/secure"
                ]
            },
            "Overhaul": {
                "Frame/Fork": [
                    "Inspect frame for damage/wear including dropouts, main tubes, seat clamp area, bottle cage and accessory mounting points",
                    "Inspect fork for damage/wear including dropouts, main tubes, crown, steerer tube and accessory mounting points",
                    "Inspect / adjust suspension linkages (if required)",
                    "Suspension forks, clean/inspect seals and upper tubes. Check for function"
                ],
                "Handlebar/Headset/Stem": [
                    "Inspect headset for wear/corrosion, adjust",
                    "Inspect handlebar for wear/damage adjust",
                    "Inspect stem for wear, straight the stem",
                    "Inspect handlebar tape/grips for wear/damage",
                    "Change handlebar tape (if damage, purchase extra)"
                ],
                "Wheels/Tires": [
                    "Inspect spokes and rim for wear/damage, change spokes (if necessary, material extra cost)",
                    "Inspect tires for condition and wear",
                    "Inspect tubeless system, top-up or replace consumables as appropriate"
                ],
                "Brakes": [
                    "Inspect condition of hose/cable, change",
                    "Inspect caliper for correct function including clean/lube pistons",
                    "Inspect brake rotor for wear/damage/torque",
                    "Inspect condition of lever, including main body, blades and position. Adjust if required.",
                    "Adjust brake, ensure correct function including no rub and appropriate bite-point"
                ],
                "Bottom Bracket/Cranks": [
                    "Inspect chain rings/crank arms/spindle for wear/damage",
                    "Inspect bottom bracket torque, ensure free rotation of bearings"
                ],
                "Pedals": [
                    "Inspect pedal body for wear/damage",
                    "Ensure smooth rotation of pedal bearings and check for play"
                ],
                "Drivetrain/Gears": [
                    "Inspect chain for wear/damage, lubricate",
                    "Inspect front derailleur",
                    "Inspect rear derailleur",
                    "Index front derailleur",
                    "Index rear derailleur",
                    "Inspect cassette for wear/damage and torque",
                    "Ensure derailleur hanger is straight and secure",
                    "Set front derailleur position/height"
                ],
                "Saddle": [
                    "Check saddle for wear/damage",
                    "Inspect seat post and clamp",
                    "Insect saddle rails/clamps",
                    "Grease/fiber grip as appropriate"
                ]
            },
            "Dream Build": {
                "Build List": [
                    "Frame", "Fork", "Handlebar", "Headset", "Stem", "Wheelset",
                    "Tires", "Brakes", "Brake Pad", "Bottom Bracket", "Crank",
                    "Chainring(s)", "Front Derailleur", "Rear Derailleur", "Cassette",
                    "Pedals", "Seat post", "Saddle"
                ]
            },
            "A La Carte": {
                "Services": [
                    "Gear Indexing", "Tubeless Tire setup", "Tire tubed setup", "Pedal Install",
                    "Brake adjustments", "Shift Adjustments", "Disassemble/Assemble bike for shipping",
                    "Chain Installation", "Bike Assembly from box (Childs bike)", "Bike Assembly from box (Adults bike)"
                ]
            }
        };

        // Seed data if empty
        if (!localStorage.getItem('workshop_inventory')) {
            const initialInventory = [
                { id: 1, name: 'Shift Cable (Stainless)', qty: 15, min: 5 },
                { id: 2, name: 'Brake Cable (Road)', qty: 8, min: 5 },
                { id: 3, name: '700c Inner Tube', qty: 23, min: 10 },
                { id: 4, name: 'Disc Brake Pads (SRAM)', qty: 2, min: 4 }
            ];
            localStorage.setItem('workshop_inventory', JSON.stringify(initialInventory));
        }

        // Seed jobs if empty (Demo Data)
        if (!localStorage.getItem('workshop_jobs')) {
            const initialJobs = [
                {
                    id: '1701',
                    status: 'booked',
                    customer: 'Demo User',
                    bike: 'Cannondale Synapse',
                    service: 'The Tune-Up',
                    date: new Date().toISOString()
                },
                {
                    id: '1702',
                    status: 'working',
                    customer: 'Sarah Connor',
                    bike: 'Terminator T-800',
                    service: 'Safety Check',
                    date: new Date(Date.now() - 86400000).toISOString()
                }
            ];
            localStorage.setItem('workshop_jobs', JSON.stringify(initialJobs));
        }

        // --- APP LOGIC ---

        function init() {
            renderDashboard();
            renderKanban();
            renderInventory();
            checkNewSubmissions();
        }

        // --- DASHBOARD LOGIC ---

        function renderDashboard() {
            renderActionRequired();
            renderRecents();
            renderAgenda();
            renderChart();
            renderShopHours();
        }

        function renderActionRequired() {
            const list = document.getElementById('action-required-list');
            list.innerHTML = '';
            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];

            // Filter Booked In
            const bookedJobs = jobs.filter(j => j.status === 'booked');

            if (bookedJobs.length === 0) {
                list.innerHTML = '<div class="text-gray-500 italic text-center py-4">No pending actions. Good job!</div>';
                return;
            }

            bookedJobs.forEach(job => {
                // Use createCardElement to ensure consistency? No, action required is different style.
                // Keep existing logic but maybe fix click?
                const div = document.createElement('div');
                div.className = "bg-brand-dark p-4 rounded-xl border border-gray-700 hover:border-brand-orange cursor-pointer transition group";
                div.onclick = () => { openJobSheet(job.id); };
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-white text-lg">${job.customer}</h4>
                        <span class="text-xs bg-brand-orange px-2 py-1 rounded text-white font-bold uppercase">Booked In</span>
                    </div>
                    <p class="text-sm text-gray-400">${job.bike} - ${job.service}</p>
                    <div class="mt-2 text-xs text-brand-orange flex items-center gap-1 group-hover:underline">
                        Tap to open Job Sheet <i class="fa-solid fa-file-invoice"></i>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderRecents() {
            const list = document.getElementById('recents-list');
            list.innerHTML = '';
            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];

            // Sort by Date Descending
            jobs.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recents = jobs.slice(0, 5);

            recents.forEach(job => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center border-b border-gray-800/50 pb-2 last:border-0";
                li.innerHTML = `
                    <div>
                        <div class="text-white font-bold">${job.customer}</div>
                        <div class="text-xs text-gray-500">${new Date(job.date).toLocaleDateString()}</div>
                    </div>
                    <span class="text-xs uppercase px-2 py-0.5 rounded bg-gray-800 text-gray-400 border border-gray-700">${job.status}</span>
                `;
                list.appendChild(li);
            });
        }

        // --- DASHBOARD ANALYTICS & AGENDA ---
        let _currentAgendaDate = new Date();
        let _jobsChart = null;

        function renderAgenda() {
            const list = document.getElementById('agenda-list');
            const dateLabel = document.getElementById('agenda-date');

            // Format Date Label
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            dateLabel.textContent = _currentAgendaDate.toLocaleDateString(undefined, options);

            // Filter Jobs
            // Note: Our jobs store 'date' string (YYYY-MM-DD). We compare localized strings or raw? 
            // The job.date comes from new Date().toISOString().split('T')[0] in confirmNewJob.
            // So we should compare YYYY-MM-DDstrings.

            // Adjust current agenda date to YYYY-MM-DD local
            // This is a bit tricky with timezones. Let's use the simple string approach.
            const y = _currentAgendaDate.getFullYear();
            const m = String(_currentAgendaDate.getMonth() + 1).padStart(2, '0');
            const d = String(_currentAgendaDate.getDate()).padStart(2, '0');
            const queryDate = `${y}-${m}-${d}`;

            const jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const daysJobs = jobs.filter(j => j.date === queryDate);

            list.innerHTML = '';
            if (daysJobs.length === 0) {
                list.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-gray-500 opacity-50 min-h-[150px]">
                        <i class="fa-solid fa-calendar-xmark text-4xl mb-2"></i>
                        <p class="uppercase font-bold tracking-widest text-sm">No Jobs</p>
                    </div>
                `;
            } else {
                daysJobs.forEach(job => {
                    const colors = {
                        'booked': 'border-gray-400',
                        'working': 'border-brand-orange',
                        'ready': 'border-green-500',
                        'completed': 'border-gray-800'
                    };
                    const color = colors[job.status] || 'border-blue-500';

                    const div = document.createElement('div');
                    div.className = `bg-[#151535] p-3 rounded border-l-4 ${color} border-y border-r border-gray-800 flex justify-between items-center group cursor-pointer hover:bg-white/5 transition`;

                    // Simple view or edit?
                    // div.onclick = () => ... 

                    div.innerHTML = `
                        <div>
                            <h4 class="font-bold text-white text-sm">${job.customer}</h4>
                            <p class="text-xs text-gray-400">${job.bike}  <span class="text-brand-orange">${job.service}</span></p>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">${job.status.replace('_', ' ')}</span>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }

        function changeDay(delta) {
            _currentAgendaDate.setDate(_currentAgendaDate.getDate() + delta);
            renderAgenda();
        }

        function resetDay() {
            _currentAgendaDate = new Date();
            renderAgenda();
        }

        function renderChart() {
            const ctx = document.getElementById('jobsChart');
            if (!ctx) return;

            const jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];

            // Aggregation: Count ALL jobs (past and present)
            const counts = {
                'Safety Check': 0,
                'The Tune-Up': 0,
                'Overhaul': 0,
                'Dream Build': 0,
                'A La Carte': 0
            };

            jobs.forEach(j => {
                if (counts[j.service] !== undefined) {
                    counts[j.service]++;
                } else {
                    counts['A La Carte']++;
                }
            });

            // If no data, show placeholder? ChartJS handles all 0s okay usually (blank)

            const data = {
                labels: Object.keys(counts),
                datasets: [{
                    data: Object.values(counts),
                    backgroundColor: [
                        '#3b82f6', // Safety (Blue)
                        '#22c55e', // TuneUp (Green)
                        '#eab308', // Overhaul (Yellow)
                        '#f97316', // Dream (Orange)
                        '#a855f7'  // AlaCarte (Purple)
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            };

            if (_jobsChart) {
                _jobsChart.destroy();
            }

            _jobsChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#9ca3af',
                                boxWidth: 12,
                                font: { size: 10, family: "'Roboto Condensed', sans-serif" }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // SHOP HOURS
        function renderChart() {
            const ctx = document.getElementById('jobsChart');
            if (!ctx) return;

            const jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];

            // Filter: Active Only (not completed)
            const activeJobs = jobs.filter(j => j.status !== 'completed');

            // Aggregation
            const counts = {
                'Active': 0,
                'Booked': 0,
                'Ready': 0
            };
            // Or breakdown by Service Type for ACTIVE jobs? 
            // "how many active bikes are in service currently with a pie chart"
            // Usually implies breakdown by status or service. Let's do Service breakdown of ACTIVE jobs.

            const serviceCounts = {
                'Safety Check': 0,
                'The Tune-Up': 0,
                'Overhaul': 0,
                'Dream Build': 0,
                'A La Carte': 0
            };

            activeJobs.forEach(j => {
                const s = (j.service || '').toLowerCase();
                if (s.includes('safety')) serviceCounts['Safety Check']++;
                else if (s.includes('tune')) serviceCounts['The Tune-Up']++;
                else if (s.includes('overhaul')) serviceCounts['Overhaul']++;
                else if (s.includes('dream')) serviceCounts['Dream Build']++;
                else serviceCounts['A La Carte']++;
            });

            const total = activeJobs.length;

            if (_jobsChart) {
                _jobsChart.destroy();
                _jobsChart = null;
            }

            if (total === 0) {
                const data = {
                    labels: ['No Active Jobs'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#1f2937'],
                        borderWidth: 0
                    }]
                };
                _jobsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        events: [],
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        cutout: '70%'
                    }
                });
                return;
            }

            const data = {
                labels: Object.keys(serviceCounts),
                datasets: [{
                    data: Object.values(serviceCounts),
                    backgroundColor: [
                        '#3b82f6', // Safety
                        '#22c55e', // TuneUp
                        '#eab308', // Overhaul
                        '#f97316', // Dream
                        '#a855f7'  // AlaCarte
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            };

            _jobsChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#9ca3af',
                                boxWidth: 12,
                                font: { size: 10, family: "'Roboto Condensed', sans-serif" }
                            }
                        },
                        title: {
                            display: true,
                            text: `${total} Bikes In Shop`,
                            color: 'white',
                            position: 'bottom',
                            font: { family: "'Teko', sans-serif", size: 16 }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // SHOP HOURS
        function renderShopHours() {
            const hours = localStorage.getItem('workshop_hours') || "Mon-Fri: 9am - 5pm\nSat: 10am - 2pm\nSun: Closed";
            document.getElementById('shop-hours').textContent = hours;
        }

        function editShopHours() {
            const current = document.getElementById('shop-hours').textContent;
            const newHours = prompt("Edit Shop Hours:", current);
            if (newHours) {
                localStorage.setItem('workshop_hours', newHours);
                renderShopHours();
            }
        }

        function checkNewSubmissions() {
            // Check if there's a new submission from contact.html in localStorage
            const newJob = localStorage.getItem('new_service_request');
            if (newJob) {
                const jobData = JSON.parse(newJob);
                addJobCard(jobData);
                localStorage.removeItem('new_service_request'); // Clear it so it doesn't duplicate
            }
        }

        // KANBAN
        function renderKanban() {
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';

            // Get Jobs
            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];

            COLUMNS.forEach(col => {
                const colDiv = document.createElement('div');
                colDiv.className = 'w-80 bg-[#151535] rounded-xl flex flex-col flex-shrink-0 h-full max-h-full shadow-xl border border-gray-800';
                colDiv.innerHTML = `
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#0B0B2B] rounded-t-xl ${col.color}">
                        <h3 class="font-display font-bold text-xl uppercase tracking-wider text-gray-200">${col.title}</h3>
                        <span class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-400 count-badge">0</span>
                    </div>
                    <div class="p-2 overflow-y-auto flex-grow kanban-col space-y-2 relative" 
                         id="col-${col.id}" 
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)">
                    </div>
                `;
                board.appendChild(colDiv);

                // Populate Cards
                const colJobs = jobs.filter(j => j.status === col.id);
                const container = colDiv.querySelector(`#col-${col.id}`);
                colDiv.querySelector('.count-badge').textContent = colJobs.length;

                colJobs.forEach(job => {
                    const card = createCardElement(job);
                    container.appendChild(card);
                });
            });
        }

        function createCardElement(job) {
            const div = document.createElement('div');
            // Use hex color to ensure visibility
            div.className = 'bg-[#151525] p-4 rounded-xl border border-gray-700 shadow-lg cursor-grab active:cursor-grabbing hover:border-brand-orange transition group relative flex flex-col gap-2';
            div.draggable = true;
            // Ensure ID is string
            const safeId = String(job.id || Date.now());
            div.id = `job-${safeId}`;
            div.ondragstart = drag;

            div.onclick = (e) => {
                if (e.target.closest('button')) return;
                openJobSheet(job.id);
            };

            const displayId = safeId.length >= 4 ? safeId.substring(safeId.length - 4) : safeId;
            const customerName = job.customer || job.name || 'Unknown Customer';
            const serviceName = job.service || 'Service';
            const bikeName = job.bike || 'Bike Model';
            const dateStr = job.date ? new Date(job.date).toLocaleDateString() : 'No Date';

            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="text-xs font-mono text-gray-500">#${displayId}</span>
                    <span class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-brand-orange uppercase tracking-wide font-bold">${serviceName}</span>
                </div>
                <div class="flex-grow">
                    <h4 class="font-bold text-white text-lg leading-tight mb-0.5">${customerName}</h4>
                    <p class="text-xs text-gray-400 font-medium">${bikeName}</p>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-gray-800/50 mt-1">
                     <div class="text-[10px] text-gray-500 font-bold uppercase"><i class="fa-regular fa-calendar mr-1"></i> ${dateStr}</div>
                     <button onclick="event.stopPropagation(); deleteJob('${String(job.id)}')" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            return div;
        }

        function addJobCard(data) {
            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const newJob = {
                id: Date.now().toString(),
                status: 'booked',
                customer: data.fullname,
                email: data.email, // Save email
                phone: data.phone, // Save phone
                bike: data.bike,
                service: data.service,
                date: new Date().toISOString()
            };
            jobs.push(newJob);
            localStorage.setItem('workshop_jobs', JSON.stringify(jobs));

            // Sync Contact to API (Non-blocking)
            fetchContacts().then(contacts => {
                const existing = contacts.find(c => c.name === data.fullname);
                const contactPayload = {
                    id: existing ? existing.id : Date.now().toString(),
                    name: data.fullname,
                    email: data.email || (existing ? existing.email : ''),
                    phone: data.phone || (existing ? existing.phone : ''),
                    lastSeen: newJob.date,
                    count: (existing ? existing.job_count : 0) + 1
                };
                saveContactAPI(contactPayload);
            });

            renderKanban();
        }

        // DRAG AND DROP
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.classList.add('dragging');
        }

        // INVENTORY SELECTION LOGIC
        let _pendingJobMove = null;

        function openInventorySelection(jobId, targetCol) {
            _pendingJobMove = { jobId, targetCol };
            const modal = document.getElementById('inventory-selection-modal');
            const select = document.getElementById('inventory-select-dropdown');

            // Populate Dropdown
            const inventory = JSON.parse(localStorage.getItem('workshop_inventory')) || [];
            select.innerHTML = '<option value="">-- Select Part --</option>';
            inventory.forEach(item => {
                select.innerHTML += `<option value="${item.id}">${item.name} (Qty: ${item.qty})</option>`;
            });

            modal.showModal();
        }

        function cancelPartSelection() {
            document.getElementById('inventory-selection-modal').close();
            _pendingJobMove = null;
            renderKanban(); // Revert UI
        }

        function confirmPartSelection() {
            const select = document.getElementById('inventory-select-dropdown');
            const partId = parseInt(select.value); // IDs are numbers in current data

            if (!partId) {
                alert("Please select a part.");
                return;
            }

            // Deduct Inventory
            let inventory = JSON.parse(localStorage.getItem('workshop_inventory')) || [];
            const itemIndex = inventory.findIndex(i => i.id === partId);

            if (itemIndex > -1) {
                if (inventory[itemIndex].qty > 0) {
                    inventory[itemIndex].qty--;
                    localStorage.setItem('workshop_inventory', JSON.stringify(inventory));
                } else {
                    if (!confirm("This item is out of stock. Proceed anyway?")) return;
                    inventory[itemIndex].qty--;
                    localStorage.setItem('workshop_inventory', JSON.stringify(inventory));
                }
            }

            // Complete Move
            if (_pendingJobMove) {
                let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
                const jobIndex = jobs.findIndex(j => String(j.id) === String(_pendingJobMove.jobId));
                if (jobIndex > -1) {
                    jobs[jobIndex].status = 'parts';
                    localStorage.setItem('workshop_jobs', JSON.stringify(jobs));
                }
            }

            document.getElementById('inventory-selection-modal').close();
            _pendingJobMove = null;
            init(); // Re-render everything
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const card = document.getElementById(data);
            card.classList.remove('dragging');

            // Find drop target (handle dropping on child elements)
            let targetCol = ev.target;
            while (!targetCol.classList.contains('kanban-col')) {
                targetCol = targetCol.parentElement;
                if (!targetCol) return;
            }

            targetCol.appendChild(card);

            // Update State
            const newStatus = targetCol.id.replace('col-', '');
            const jobId = data.replace('job-', '');

            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const jobIndex = jobs.findIndex(j => j.id === jobId);

            if (jobIndex > -1) {
                const oldStatus = jobs[jobIndex].status;

                // Intercept Approval -> Waiting Parts
                if (oldStatus === 'approval' && newStatus === 'parts') {
                    openInventorySelection(jobId, targetCol);
                    return;
                }

                jobs[jobIndex].status = newStatus;
                localStorage.setItem('workshop_jobs', JSON.stringify(jobs));
                renderKanban(); // Re-render to update counts
            }
        }

        function deleteJob(id) {
            if (confirm('Archive this job record?')) {
                let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
                // Coerce to string for robust comparison (handles "1701" vs 1701 type mismatches)
                jobs = jobs.filter(j => String(j.id) !== String(id));
                localStorage.setItem('workshop_jobs', JSON.stringify(jobs));
                renderKanban();
            }
        }

        // INVENTORY
        const INVENTORY_CATEGORIES = [
            "Wheelset/Tires",
            "Handlebars/Steering",
            "Fork/Frame",
            "Saddle/Post",
            "Bottom Bracket/Crankset",
            "Mech",
            "Chain/Cassette",
            "Other"
        ];

        function renderInventory() {
            const container = document.getElementById('inventory-table-body');
            container.innerHTML = '';
            let items = JSON.parse(localStorage.getItem('workshop_inventory')) || [];

            // Ensure every item has a category
            items = items.map(i => ({ ...i, category: i.category || 'Other' }));

            INVENTORY_CATEGORIES.forEach(cat => {
                const catItems = items.filter(i => i.category === cat);
                // Show header request

                const isCollapsed = localStorage.getItem(`cat_collapsed_${cat}`) === 'true';

                // Header Row
                const headerTr = document.createElement('tr');
                headerTr.className = "bg-[#151535] cursor-pointer hover:bg-[#1a1a45] text-left";
                headerTr.onclick = () => {
                    localStorage.setItem(`cat_collapsed_${cat}`, !isCollapsed);
                    renderInventory();
                };

                headerTr.innerHTML = `
                    <td colspan="4" class="p-3 font-bold text-gray-200 uppercase tracking-wider text-xs">
                        <i class="fa-solid fa-chevron-${isCollapsed ? 'right' : 'down'} mr-2 w-4"></i> ${cat} <span class="text-gray-500 ml-2">(${catItems.length})</span>
                    </td>
                `;
                container.appendChild(headerTr);

                if (!isCollapsed) {
                    catItems.forEach((item) => {
                        const tr = document.createElement('tr');
                        const isLow = item.qty <= item.min;
                        tr.className = "hover:bg-white/5 transition border-b border-gray-800/30 text-sm";
                        tr.innerHTML = `
                            <td class="p-3 font-medium text-white pl-8 border-l-2 border-transparent hover:border-brand-orange">
                                ${item.name}
                            </td>
                            <td class="p-3">
                                <div class="flex items-center gap-2">
                                     <button onclick="updateQty(${item.id}, -1)" class="w-6 h-6 bg-gray-800 hover:bg-gray-700 rounded text-xs">-</button>
                                     <span class="w-8 text-center">${item.qty}</span>
                                     <button onclick="updateQty(${item.id}, 1)" class="w-6 h-6 bg-gray-800 hover:bg-gray-700 rounded text-xs">+</button>
                                </div>
                            </td>
                            <td class="p-3">
                                ${isLow
                                ? '<span class="text-red-500 text-[10px] font-bold uppercase tracking-wider bg-red-900/20 px-2 py-1 rounded">Low</span>'
                                : '<span class="text-green-500 text-[10px] font-bold uppercase tracking-wider bg-green-900/20 px-2 py-1 rounded">OK</span>'}
                            </td>
                            <td class="p-3 text-right flex justify-end items-center gap-1">
                                 <div class="flex flex-col mr-3 text-gray-600">
                                    <button onclick="moveItem(${item.id}, -1)" class="hover:text-white text-[10px]" title="Move Up"><i class="fa-solid fa-chevron-up"></i></button>
                                    <button onclick="moveItem(${item.id}, 1)" class="hover:text-white text-[10px]" title="Move Down"><i class="fa-solid fa-chevron-down"></i></button>
                                 </div>
                                 <button onclick="editItem(${item.id})" title="Edit" class="text-gray-500 hover:text-brand-orange p-1"><i class="fa-solid fa-pen"></i></button>
                                 <button onclick="removeItem(${item.id})" title="Delete" class="text-gray-500 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        `;
                        container.appendChild(tr);
                    });
                }
            });
        }

        function updateQty(id, change) {
            let items = JSON.parse(localStorage.getItem('workshop_inventory')) || [];
            const idx = items.findIndex(i => i.id === id);
            if (idx > -1) {
                items[idx].qty = Math.max(0, items[idx].qty + change);
                localStorage.setItem('workshop_inventory', JSON.stringify(items));
                renderInventory();
            }
        }

        // Helper to prompt category
        function promptCategory(current) {
            let num = prompt(
                `Select Category(Enter Number): \n` +
                INVENTORY_CATEGORIES.map((c, i) => `${i + 1}. ${c} `).join('\n'),
                current ? (INVENTORY_CATEGORIES.indexOf(current) + 1) : "8"
            );
            if (!num) return null;
            const idx = parseInt(num) - 1;
            if (idx >= 0 && idx < INVENTORY_CATEGORIES.length) return INVENTORY_CATEGORIES[idx];
            return "Other";
        }

        function addItem() {
            const name = prompt("Item Name:");
            if (!name) return;
            const qty = parseInt(prompt("Current Quantity:", "1") || "0");
            const min = parseInt(prompt("Low Stock Warning Level:", "5") || "5");
            const category = promptCategory("Other");
            if (!category) return;

            let items = JSON.parse(localStorage.getItem('workshop_inventory')) || [];
            items.push({ id: Date.now(), name, qty, min, category });
            localStorage.setItem('workshop_inventory', JSON.stringify(items));
            renderInventory();
        }

        function editItem(id) {
            let items = JSON.parse(localStorage.getItem('workshop_inventory')) || [];
            const idx = items.findIndex(i => i.id === id);
            if (idx === -1) return;

            const existingName = items[idx].name;
            const existingQty = items[idx].qty;
            const existingMin = items[idx].min || 5;
            const existingCat = items[idx].category || "Other";

            const name = prompt("Edit Item Name:", existingName);
            if (name === null) return;

            const qtyStr = prompt("Edit Quantity:", existingQty);
            if (qtyStr === null) return;
            const qty = parseInt(qtyStr || "0");

            const minStr = prompt("Low Stock Warning Level:", existingMin);
            if (minStr === null) return;
            const min = parseInt(minStr || "5");

            const category = promptCategory(existingCat);
            if (!category) return;

            items[idx] = { ...items[idx], name, qty, min, category };
            localStorage.setItem('workshop_inventory', JSON.stringify(items));
            renderInventory();
        }

        function moveItem(id, direction) {
            // Reordering logic: We need to swap the item with its neighbor *within the same category* in the main list.
            // This is tricky because the main list might not be sorted by category. 
            // Better approach: Sort the main list by category first? 
            // Or just swap indexes if they are adjacent? 
            // "Reorder" implies persistent order. Array order defines display order.
            // If we group by category in render, the array order MATTERS primarily within the category subset.

            let items = JSON.parse(localStorage.getItem('workshop_inventory')) || [];
            const idx = items.findIndex(i => i.id === id);
            if (idx === -1) return;

            const item = items[idx];
            // Get all items of this category
            const catItems = items.map((it, index) => ({ ...it, originalIndex: index })).filter(it => (it.category || 'Other') === (item.category || 'Other'));

            // Find position of current item in the category subset
            const subIdx = catItems.findIndex(it => it.id === id);

            if (direction === -1 && subIdx > 0) {
                // Move Up
                const neighbor = catItems[subIdx - 1];
                // Swap in master list
                const temp = items[neighbor.originalIndex];
                items[neighbor.originalIndex] = items[idx];
                items[idx] = temp;
            } else if (direction === 1 && subIdx < catItems.length - 1) {
                // Move Down
                const neighbor = catItems[subIdx + 1];
                // Swap in master list
                const temp = items[neighbor.originalIndex];
                items[neighbor.originalIndex] = items[idx];
                items[idx] = temp;
            }

            localStorage.setItem('workshop_inventory', JSON.stringify(items));
            renderInventory();
        }

        function removeItem(id) {
            if (confirm('Delete item from inventory?')) {
                let items = JSON.parse(localStorage.getItem('workshop_inventory')) || [];
                items = items.filter(i => i.id !== id);
                localStorage.setItem('workshop_inventory', JSON.stringify(items));
                renderInventory();
            }
        }

        // CONTACTS LOGIC

        // API HELPERS
        // Reverted to localhost for desktop/laptop stability
        const API_URL = 'http://localhost:3000/api';

        async function fetchContacts() {
            const statusIndicator = document.getElementById('api-status');
            try {
                const res = await fetch(`${API_URL}/contacts`);
                if (!res.ok) throw new Error('API Error');

                if (statusIndicator) {
                    statusIndicator.className = "mt-2 text-xs font-bold text-green-400 flex items-center gap-1 uppercase tracking-wider";
                    statusIndicator.innerHTML = '<div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div> Secure Link Active';
                }

                return await res.json();
            } catch (e) {
                console.error("API Error:", e);
                if (statusIndicator) {
                    statusIndicator.className = "mt-2 text-xs font-bold text-red-500 flex items-center gap-1 uppercase tracking-wider";
                    statusIndicator.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Server Offline';
                }
                return [];
            }
        }


        async function saveContactAPI(contact) {
            try {
                console.log("Saving contact...", contact);
                await fetch(`${API_URL}/contacts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contact)
                });
            } catch (e) {
                console.error("Save Error:", e);
            }
        }

        async function deleteContactAPI(id) {
            try {
                await fetch(`${API_URL}/contacts/${id}`, { method: 'DELETE' });
            } catch (e) {
                console.error("Delete Error:", e);
            }
        }

        // Global cache for editing
        let _cachedContacts = [];

        // CONTACTS LOGIC
        // SELECTION STATE
        let _selectedContacts = new Set();
        let _contactsData = []; // Store fetched data locally

        // INITIAL LOAD
        async function loadContacts() {
            _contactsData = await fetchContacts();

            // Migration check
            if (_contactsData.length === 0) {
                const localJobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
                if (localJobs.length > 0) {
                    // Auto-migration simplified:
                    // We just fetch again in case server populated it or rely on script to have run.
                    // For stability, we won't re-inject the huge migration block here unless requested.
                }
            }
            renderContactsTable();
        }

        function renderContactsTable() {
            const tbody = document.getElementById('contacts-table-body');
            if (!tbody) return;

            const searchInput = document.getElementById('contact-search');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            const jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];

            tbody.innerHTML = '';

            if (_contactsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500 italic">No contacts found.</td></tr>';
                updateSelectionUI();
                return;
            }

            _contactsData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            const filtered = _contactsData.filter(c => (c.name || '').toLowerCase().includes(search) || (c.email || '').toLowerCase().includes(search));

            filtered.forEach(c => {
                if (!c.id) return; // Skip invalid IDs to prevent bugs

                const count = c.job_count || jobs.filter(j => j.customer === c.name).length;

                // FORCE STRING ID
                const strId = String(c.id);
                const isSelected = _selectedContacts.has(strId);

                // Safe values for HTML
                const safeId = strId.replace(/['"\\]/g, '\\\\$&');
                const safeName = String(c.name).replace(/'/g, "\\'");

                const tr = document.createElement('tr');
                tr.className = `transition group border-b border-gray-800/50 ${isSelected ? 'bg-brand-orange/10' : 'hover:bg-white/5'}`;
                tr.onclick = (e) => {
                    // Prevent toggle when clicking buttons or inputs directly
                    if (e.target.closest('button') || e.target.closest('input')) return;
                    toggleContactSelection(strId);
                };

                tr.innerHTML = `
                    <td class="p-4 text-center">
                        <input type="checkbox" 
                            class="w-5 h-5 rounded cursor-pointer accent-[#FF8000]"
                            ${isSelected ? 'checked' : ''} 
                            onclick="toggleContactSelection('${safeId}', event)">
                    </td>
                    <td class="p-4 font-bold text-white">${c.name}</td>
                    <td class="p-4 text-sm text-gray-400">${c.email || ''}</td>
                    <td class="p-4 text-sm text-gray-400">${c.phone || ''}</td>
                    <td class="p-4 text-sm"><span class="bg-gray-800 px-2 py-1 rounded text-white font-bold">${count}</span></td>
                    <td class="p-4 text-sm text-gray-400">${c.last_seen ? new Date(c.last_seen).toLocaleDateString() : ''}</td>
                    <td class="p-4 text-right flex justify-end gap-2 text-gray-600">
                        <button onclick="startNewJob('${safeId}')" title="New Job" class="hover:text-green-500 p-2"><i class="fa-solid fa-plus"></i></button>
                        <button onclick="viewContactHistory('${safeId}', '${safeName}')" title="Job History" class="hover:text-brand-orange p-2"><i class="fa-solid fa-clock-rotate-left"></i></button>
                        <button onclick="editContact('${safeId}')" title="Edit Contact" class="hover:text-white p-2"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteContact('${safeId}')" title="Delete Contact" class="hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updateSelectionUI();
        }

        // ENTRY POINT (Renamed existing renderContacts calls to loadContacts if specific fetch needed, or just renderContactsTable if local)
        // Compatibility wrapper:
        async function renderContacts() {
            await loadContacts();
        }

        function toggleContactSelection(id, event) {
            if (event) event.stopPropagation();

            // If ID is undefined/null, handle gracefully
            if (!id) return;

            // Force ID to string to match Set storage
            const strId = String(id);

            if (_selectedContacts.has(strId)) {
                _selectedContacts.delete(strId);
            } else {
                _selectedContacts.add(strId);
            }
            renderContactsTable(); // Re-render ONLY DOM, do not fetch
        }

        function toggleAllContacts() {
            const selectAll = document.getElementById('select-all-contacts');
            const isChecked = selectAll.checked;

            if (isChecked) {
                // Select currently visible (filtered) contacts
                const searchInput = document.getElementById('contact-search');
                const search = searchInput ? searchInput.value.toLowerCase() : '';
                const visible = _contactsData.filter(c => (c.name || '').toLowerCase().includes(search) || (c.email || '').toLowerCase().includes(search));

                visible.forEach(c => _selectedContacts.add(String(c.id)));
            } else {
                _selectedContacts.clear();
            }
            renderContactsTable();
        }

        function updateSelectionUI() {
            const btn = document.getElementById('delete-selected-btn');
            const selectAll = document.getElementById('select-all-contacts');

            // 1. Update Delete Button
            if (_selectedContacts.size > 0) {
                btn.classList.remove('hidden');
                btn.innerHTML = `<i class="fa-solid fa-trash mr-1"></i> Delete (${_selectedContacts.size})`;
            } else {
                btn.classList.add('hidden');
            }

            // 2. Update "Select All" Checkbox State
            // We need to know if *all visible* contacts are selected.
            const searchInput = document.getElementById('contact-search');
            const search = searchInput ? searchInput.value.toLowerCase() : '';

            // Filter visible same as render logic
            const visible = _contactsData.filter(c => (c.name || '').toLowerCase().includes(search) || (c.email || '').toLowerCase().includes(search));

            if (visible.length > 0) {
                const allSelected = visible.every(c => _selectedContacts.has(String(c.id)));
                if (selectAll) {
                    selectAll.checked = allSelected;
                    // Optional: Indeterminate state if some but not all?
                    // selectAll.indeterminate = _selectedContacts.size > 0 && !allSelected;
                }
            } else {
                if (selectAll) selectAll.checked = false;
            }
        }

        async function deleteSelectedContacts() {
            const ids = Array.from(_selectedContacts);
            if (ids.length === 0) return;

            if (!confirm(`Are you sure you want to delete ${ids.length} contacts? This cannot be undone.`)) return;

            try {
                const res = await fetch(`${API_URL}/contacts/batch-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });

                if (res.ok) {
                    _selectedContacts.clear();
                    // Now re-fetch to confirm deletion source of truth
                    await loadContacts();
                } else {
                    alert("Failed to delete contacts.");
                }
            } catch (e) {
                console.error(e);
                alert("Server error.");
            }
        }

        async function editContact(id) {
            // Find in cache
            const contact = _contactsData.find(c => c.id === id);
            if (!contact) return;

            document.getElementById('edit-contact-id').value = contact.id;
            document.getElementById('edit-contact-name').value = contact.name;
            document.getElementById('edit-contact-email').value = contact.email;
            document.getElementById('edit-contact-phone').value = contact.phone;

            document.getElementById('edit-contact-modal').showModal();
        }

        async function saveContact() {
            const id = document.getElementById('edit-contact-id').value;
            const name = document.getElementById('edit-contact-name').value;
            const email = document.getElementById('edit-contact-email').value;
            const phone = document.getElementById('edit-contact-phone').value;

            // Optimistic UI update
            await saveContactAPI({
                id,
                name,
                email,
                phone,
                lastSeen: new Date().toISOString()
            });

            document.getElementById('edit-contact-modal').close();
            await renderContacts(); // Refresh
        }

        async function deleteContact(id) {
            if (!confirm("Permenantly delete this encrypted contact?")) return;
            await deleteContactAPI(id);
            await renderContacts();
        }

        // IMPORT / EXPORT LOGIC
        function exportContactsCSV() {
            if (!_contactsData || _contactsData.length === 0) {
                alert("No contacts to export.");
                return;
            }

            // Headers matches QuickBooks-friendly format where possible, though QB usually needs specific mapping.
            // Simple generic CSV: Name,Email,Phone,TotalJobs,LastSeen
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Customer Name,Email,Phone,Job Count,Last Seen\n";

            _contactsData.forEach(c => {
                const name = (c.name || '').replace(/,/g, ''); // Simple escape
                const email = (c.email || '').replace(/,/g, '');
                const phone = (c.phone || '').replace(/,/g, '');
                const count = c.job_count || 0;
                const last = c.last_seen || '';
                csvContent += `${name},${email},${phone},${count},${last}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "workshop_contacts.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function processCSVImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                const text = e.target.result;
                const lines = text.split('\n');

                let count = 0;
                // Skipping header if first row has "Name" or "Customer"
                const startIndex = (lines[0].toLowerCase().includes('name') || lines[0].toLowerCase().includes('customer')) ? 1 : 0;

                for (let i = startIndex; i < lines.length; i++) {
                    const row = lines[i].trim();
                    if (!row) continue;

                    // Simple logic: assume col 1=Name, col 2=Email, col 3=Phone (QuickBooks Export variation)
                    // If rows have quotes, this simple split fail. But sufficient for basic usage.
                    const cols = row.split(',');
                    if (cols.length < 1) continue;

                    const name = cols[0].trim();
                    const email = cols[1] ? cols[1].trim() : '';
                    const phone = cols[2] ? cols[2].trim() : '';

                    if (name) {
                        const contactPayload = {
                            id: Date.now().toString() + Math.random().toString().substr(2, 5),
                            name: name,
                            email: email,
                            phone: phone,
                            lastSeen: new Date().toISOString(),
                            count: 0
                        };
                        await saveContactAPI(contactPayload);
                        count++;
                    }
                }

                alert(`Imported ${count} contacts successfully.`);
                input.value = ''; // Reset
                renderContacts();
            };
            reader.readAsText(file);
        }

        // REPEAT CUSTOMER JOB LOGIC
        function startNewJob(contactId) {
            const contact = _cachedContacts.find(c => c.id === contactId);
            if (!contact) return;

            // Pre-fill for Existing Customer
            document.getElementById('new-job-contact-id').value = contact.id;

            const nameInput = document.getElementById('new-job-name');
            nameInput.value = contact.name;
            nameInput.readOnly = true; // Lock name for existing
            nameInput.classList.add('cursor-not-allowed', 'text-gray-400');

            document.getElementById('new-job-email').value = contact.email || '';
            document.getElementById('new-job-phone').value = contact.phone || '';

            // Clear job details
            document.getElementById('new-job-bike').value = '';
            document.getElementById('new-job-service').selectedIndex = 0;

            document.getElementById('new-job-modal').showModal();
        }

        function startWalkInJob() {
            // Clear for Walk-in (New Customer)
            document.getElementById('new-job-contact-id').value = '';

            const nameInput = document.getElementById('new-job-name');
            nameInput.value = '';
            nameInput.readOnly = false; // Unlock name
            nameInput.classList.remove('cursor-not-allowed', 'text-gray-400');

            document.getElementById('new-job-email').value = '';
            document.getElementById('new-job-phone').value = '';
            document.getElementById('new-job-bike').value = '';
            document.getElementById('new-job-service').selectedIndex = 0;

            document.getElementById('new-job-modal').showModal();
        }

        function toggleCustomService() {
            const notify = document.getElementById('new-job-service');
            const custom = document.getElementById('new-job-custom-service');
            if (notify.value === 'A La Carte') {
                custom.classList.remove('hidden');
                custom.focus();
            } else {
                custom.classList.add('hidden');
                custom.value = '';
            }
        }

        async function confirmNewJob() {
            let contactId = document.getElementById('new-job-contact-id').value;
            const nameInput = document.getElementById('new-job-name').value;
            const emailInput = document.getElementById('new-job-email').value;
            const phoneInput = document.getElementById('new-job-phone').value;
            const bike = document.getElementById('new-job-bike').value;
            const serviceSelect = document.getElementById('new-job-service');
            let service = serviceSelect.value;

            if (service === 'A La Carte') {
                const custom = document.getElementById('new-job-custom-service').value.trim();
                if (custom) {
                    service = `A La Carte: ${custom}`;
                } else {
                    alert("Please enter a custom service description.");
                    document.getElementById('new-job-custom-service').focus();
                    return;
                }
            }

            if (!bike || !service) {
                alert("Please fill in all fields (Bike and Service).");
                return;
            }

            // AUTO-CREATE CONTACT if ID is missing (Walk-in)
            if (!contactId && nameInput) {
                // DEDUPLICATION CHECK
                // Check if phone or email matches an existing contact
                if (typeof _cachedContacts !== 'undefined') {
                    const match = _cachedContacts.find(c =>
                        (emailInput && c.email && c.email.toLowerCase() === emailInput.toLowerCase()) ||
                        (phoneInput && c.phone === phoneInput)
                    );

                    if (match) {
                        // Link to existing
                        contactId = match.id;

                        // Toast
                        const toast = document.createElement('div');
                        toast.className = "fixed bottom-20 right-4 bg-brand-orange text-white px-4 py-2 rounded shadow-xl z-50 text-sm font-bold";
                        toast.innerHTML = `<i class="fa-solid fa-link mr-2"></i> Linked to existing customer: ${match.name}`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 4000);
                    }
                }

                if (!contactId) {
                    // Proceed to Create New
                    const newId = Date.now().toString();
                    try {
                        const res = await fetch(`${API_URL}/contacts`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: newId,
                                name: nameInput,
                                email: emailInput,
                                phone: phoneInput,
                                lastSeen: new Date().toISOString().split('T')[0],
                                count: 1
                            })
                        });

                        const data = await res.json();

                        if (data.success || data.id) {
                            contactId = newId;
                            renderContacts();
                        } else {
                            alert("Failed to create contact (API Error).");
                            return;
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Server Error creating contact.");
                        return;
                    }
                }
            }

            if (!contactId) {
                alert("Please select a contact or enter a new customer name.");
                return;
            }

            // Create Job Object
            const job = {
                id: Date.now().toString(),
                contactId: contactId,
                customer: nameInput || document.getElementById('new-job-name').placeholder,
                bike: bike,
                service: service,
                status: 'booked',
                date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                checklist: {}
            };

            // Save to LocalStorage
            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            jobs.push(job);
            localStorage.setItem('workshop_jobs', JSON.stringify(jobs));

            document.getElementById('new-job-modal').close();

            // Refresh UI
            renderDashboard();
            renderKanban();
            renderActionRequired();

            // Show toast
            const toast = document.createElement('div');
            toast.className = "fixed bottom-4 right-4 bg-green-600 text-white px-6 py-4 rounded shadow-2xl z-50 text-xl font-bold uppercase tracking-wide animate-bounce";
            toast.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i> Job Booked!';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // NAVIGATION
        // TABS
        function switchTab(tab) {
            // Hide all views
            ['dashboard', 'jobs', 'inventory', 'contacts'].forEach(t => {
                const view = document.getElementById(`view-${t}`);
                if (view) view.classList.add('hidden');

                const nav = document.getElementById(`nav-${t}`);
                if (nav) {
                    // Reset to inactive state (text-gray-400)
                    nav.classList.remove('bg-brand-orange', 'text-white', 'hover:bg-orange-600');
                    nav.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-white/5');
                }
            });

            // Show selected
            const activeView = document.getElementById(`view-${tab}`);
            if (activeView) activeView.classList.remove('hidden');

            const activeNav = document.getElementById(`nav-${tab}`);
            if (activeNav) {
                // Set to active state (brand orange)
                activeNav.classList.remove('text-gray-400', 'hover:text-white', 'hover:bg-white/5');
                activeNav.classList.add('bg-brand-orange', 'text-white', 'hover:bg-orange-600');
            }

            if (tab === 'dashboard') {
                renderDashboard();
            } else if (tab === 'jobs') {
                renderKanban();
            } else if (tab === 'inventory') {
                renderInventory();
            } else if (tab === 'contacts') {
                renderContacts();
            }
        }

        function addAmazonItem() {
            const name = prompt("Product Name:");
            if (!name) return;
            const link = prompt("Amazon Link (Affiliate URL):");
            if (!link) return;
            const image = prompt("Image URL (Right click image on Amazon -> Copy Image Address):");

            let stock = JSON.parse(localStorage.getItem('workshop_amazon_stock')) || [];
            const newId = stock.length > 0 ? Math.max(...stock.map(s => s.id)) + 1 : 1;

            stock.push({
                id: newId,
                name: name,
                link: link,
                image: image || "https://placehold.co/400x400?text=No+Image"
            });

            localStorage.setItem('workshop_amazon_stock', JSON.stringify(stock));
            alert("Item added to Workshop Stockroom!");
        }

        function logout() {
            localStorage.removeItem('mechanic_auth');
            window.location.href = 'index.html';
        }

        // JOB SHEET LOGIC
        function openJobSheet(jobId) {
            const jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            // Robust ID check
            const job = jobs.find(j => String(j.id) === String(jobId));
            if (!job) return;

            document.getElementById('modal-customer').textContent = job.customer;
            document.getElementById('modal-bike').innerHTML = `<i class="fa-solid fa-bicycle mr-1"></i> ${job.bike}`;
            document.getElementById('modal-service').innerHTML = `<i class="fa-solid fa-screwdriver-wrench mr-1"></i> ${job.service}`;

            renderJobParts(job);
            renderChecklist(job);
            document.getElementById('job-sheet-modal').showModal();
        }

        function closeJobSheet() {
            document.getElementById('job-sheet-modal').close();
        }

        function renderChecklist(job) {
            const container = document.getElementById('modal-checklist');
            container.innerHTML = '';

            // Normalize service name to match keys
            let serviceKey = job.service;
            // Handle matching "The Tune-Up" vs "Tune-Up" if needed, currently keys match

            const checklist = SERVICE_CHECKLISTS[serviceKey] || SERVICE_CHECKLISTS["Safety Check"]; // Fallback
            const savedState = job.checklist || {}; // { "uniqueItemString": true/false }

            if (!checklist) {
                container.innerHTML = '<div class="text-gray-500">No checklist available for this service type.</div>';
                return;
            }

            // Loop categories
            for (const [category, items] of Object.entries(checklist)) {
                const catDiv = document.createElement('div');
                catDiv.className = "checklist-category";

                catDiv.innerHTML = `<h3 class="font-display font-bold text-xl text-gray-300 uppercase mb-3 border-b border-gray-700 pb-1">${category}</h3>`;

                const ul = document.createElement('ul');
                ul.className = "space-y-3";

                items.forEach(itemHtml => {
                    // Create unique ID for state saving (simple hash or string)
                    const itemId = `${category}-${itemHtml}`.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
                    const isChecked = savedState[itemId] || false;

                    const li = document.createElement('li');
                    li.className = "flex items-start gap-3 p-3 rounded hover:bg-white/5 transition cursor-pointer";
                    li.onclick = (e) => {
                        // Prevent triggering if clicked on link (if any)
                        if (e.target.tagName === 'INPUT') return;
                        const cb = li.querySelector('input');
                        cb.checked = !cb.checked;
                        toggleCheckItem(job.id, itemId, cb.checked);
                    };

                    li.innerHTML = `
                        <input type="checkbox" ${isChecked ? 'checked' : ''} 
                            onchange="toggleCheckItem('${job.id}', '${itemId}', this.checked)"
                            class="mt-1 w-5 h-5 text-brand-orange rounded bg-gray-700 border-gray-600 focus:ring-brand-orange">
                        <div class="text-sm text-gray-300 leading-relaxed select-none ${isChecked ? 'line-through opacity-50' : ''}">${itemHtml}</div>
                    `;
                    ul.appendChild(li);
                });

                catDiv.appendChild(ul);
                container.appendChild(catDiv);
            }
        }

        // --- JOB PARTS & EXTRAS ---
        function renderJobParts(job) {
            const container = document.getElementById('modal-parts');
            const parts = job.parts || [];

            // Calculate Totals
            const servicePrice = SERVICE_PRICES[job.service] || SERVICE_PRICES['A La Carte'] || 0;
            // Checks if service price is embedded in string for A La Carte custom? For now assume simplified or specific logic
            // Actually, for A La Carte, we might want to store the price on the job object if it differs.
            // But let's stick to base logic for now.

            const partsTotal = parts.reduce((sum, p) => sum + (parseFloat(p.price) || 0), 0);
            const subtotal = servicePrice + partsTotal;
            const taxRate = 0.06; // 6% KY Sales Tax
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            let html = `
                <div class="flex justify-between items-end mb-4">
                    <h3 class="font-display font-bold text-xl uppercase text-white">Charges & Parts</h3>
                </div>
                
                <div class="overflow-hidden rounded-lg border border-gray-700 mb-4 bg-[#0B0B2B]">
                    <!-- Service Charge Row -->
                    <div class="flex justify-between items-center p-4 border-b border-gray-800">
                         <div>
                            <span class="text-white font-bold">${job.service}</span>
                            <span class="text-xs text-gray-400 block uppercase tracking-wider">Labor Service</span>
                         </div>
                         <div class="font-mono text-white">$${servicePrice.toFixed(2)}</div>
                    </div>
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-[#151535] text-xs uppercase font-bold text-gray-500">
                            <tr>
                                <th class="p-4">Item Description</th>
                                <th class="p-4 text-right w-32">Price</th>
                                <th class="p-4 w-12"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800 bg-[#0B0B2B]">
            `;

            if (parts.length === 0) {
                html += `<tr><td colspan="3" class="p-4 text-center italic text-gray-600">No additional parts added.</td></tr>`;
            } else {
                parts.forEach((p, idx) => {
                    html += `
                        <tr class="group hover:bg-[#151535] transition">
                            <td class="p-4 text-white">${p.desc}</td>
                            <td class="p-4 text-right font-mono text-brand-orange">$${parseFloat(p.price).toFixed(2)}</td>
                            <td class="p-4 text-right">
                                <button onclick="deleteJobPart('${job.id}', ${idx})" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }

            html += `
                        </tbody>
                        <tfoot class="bg-[#151535] border-t border-gray-700">
                            <tr>
                                <td class="p-4 text-right text-gray-400 uppercase text-xs font-bold">Subtotal</td>
                                <td class="p-4 text-right font-mono text-gray-300">$${subtotal.toFixed(2)}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td class="p-4 text-right text-gray-400 uppercase text-xs font-bold">KY Sales Tax (6%)</td>
                                <td class="p-4 text-right font-mono text-gray-300">$${tax.toFixed(2)}</td>
                                <td></td>
                            </tr>
                            <tr class="bg-gray-800/50">
                                <td class="p-4 text-right text-brand-orange uppercase text-sm font-bold">Total Due</td>
                                <td class="p-4 text-right font-mono text-brand-orange font-bold text-lg">$${total.toFixed(2)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Add New Part Form -->
                <div class="flex gap-2">
                    <input type="text" id="part-desc" placeholder="Add Item (e.g. Inner Tube)" class="flex-grow bg-[#151535] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none">
                    <input type="number" id="part-price" placeholder="0.00" class="w-32 bg-[#151535] border border-gray-700 rounded p-2 text-white focus:border-brand-orange outline-none font-mono">
                    <button onclick="addJobPart('${job.id}')" class="bg-gray-700 hover:bg-brand-orange text-white px-4 py-2 rounded transition font-bold"><i class="fa-solid fa-plus"></i></button>
                </div>
            `;

            container.innerHTML = html;
        }

        function addJobPart(jobId) {
            const desc = document.getElementById('part-desc').value.trim();
            const price = parseFloat(document.getElementById('part-price').value) || 0;

            if (!desc) return;

            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const idx = jobs.findIndex(j => String(j.id) === String(jobId));
            if (idx > -1) {
                if (!jobs[idx].parts) jobs[idx].parts = [];
                jobs[idx].parts.push({ desc, price });
                localStorage.setItem('workshop_jobs', JSON.stringify(jobs));
                renderJobParts(jobs[idx]);
            }
        }

        function deleteJobPart(jobId, partIndex) {
            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const idx = jobs.findIndex(j => String(j.id) === String(jobId));
            if (idx > -1 && jobs[idx].parts) {
                jobs[idx].parts.splice(partIndex, 1);
                localStorage.setItem('workshop_jobs', JSON.stringify(jobs));
                renderJobParts(jobs[idx]);
            }
        }

        function toggleCheckItem(jobId, itemId, isChecked) {
            let jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const idx = jobs.findIndex(j => String(j.id) === String(jobId));
            if (idx > -1) {
                if (!jobs[idx].checklist) jobs[idx].checklist = {};
                jobs[idx].checklist[itemId] = isChecked;
                localStorage.setItem('workshop_jobs', JSON.stringify(jobs));

                // Re-render only style updates if needed, or simple class toggle
                // For now, re-rendering might be heavy, so let's just toggle classes (optional)
                renderChecklist(jobs[idx]); // Re-render to show line-through
            }
        }

        // REAL-TIME SYNC
        window.addEventListener('storage', (e) => {
            if (e.key === 'new_service_request') {
                checkNewSubmissions();
                // Show notification
                const toast = document.createElement('div');
                toast.className = "fixed bottom-4 right-4 bg-brand-orange text-white px-6 py-4 rounded shadow-2xl z-50 text-xl font-bold uppercase tracking-wide animate-bounce";
                toast.innerHTML = '<i class="fa-solid fa-bell mr-2"></i> New Job Received!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }
        });

        // JOB HISTORY LOGIC
        // JOB HISTORY LOGIC //
        function viewContactHistory(contactId, contactName) {
            const modal = document.getElementById('job-history-modal');
            const list = document.getElementById('history-list');
            document.getElementById('history-customer-name').textContent = contactName;

            // Get Jobs
            const jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const customerJobs = jobs.filter(j => j.customer === contactName).sort((a, b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = '';
            if (customerJobs.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-center italic">No job history found.</div>';
            } else {
                customerJobs.forEach(job => {
                    const completedItems = getReadableChecklist(job);
                    const completionCount = completedItems.length;

                    const div = document.createElement('div');
                    div.className = "bg-[#0B0B2B] p-4 rounded-lg border border-gray-700 flex flex-col gap-3";
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-lg text-white">${job.service}</div>
                                <div class="text-sm text-gray-400">${job.bike} &bull; ${new Date(job.date).toLocaleDateString()}</div>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-bold uppercase ${job.status === 'completed' ? 'bg-green-900 text-green-300' : 'bg-gray-700 text-gray-300'}">${job.status.replace('-', ' ')}</span>
                        </div>
                        
                        <div class="text-sm text-gray-300 bg-black/20 p-2 rounded">
                            <i class="fa-solid fa-list-check mr-1 text-brand-orange"></i> ${completionCount} items completed
                        </div>

                        <div class="flex gap-2 mt-2">
                             <a href="mailto:${job.email || ''}?subject=Service Report: ${job.bike}&body=${generateReportBody(job, completedItems, '%0D%0A')}" 
                                class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded transition text-sm font-bold uppercase tracking-wide">
                                <i class="fa-solid fa-envelope mr-2"></i> Email
                             </a>
                             <a href="sms:${job.phone || ''}?body=${generateReportBody(job, completedItems, '%0D%0A')}%0D%0A%0D%0AReply STOP to unsubscribe." 
                                class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded transition text-sm font-bold uppercase tracking-wide">
                                <i class="fa-solid fa-comment-sms mr-2"></i> SMS
                             </a>
                             <button onclick="downloadPDF('${job.id}')" 
                                class="flex-1 bg-brand-orange hover:bg-orange-600 text-white text-center py-2 rounded transition text-sm font-bold uppercase tracking-wide shadow-lg shadow-orange-900/40">
                                <i class="fa-solid fa-file-pdf mr-2"></i> Download PDF
                             </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            modal.showModal();
        }

        // Helper to get READABLE text from messed up IDs
        function getReadableChecklist(job) {
            const checklistIds = job.checklist || {};
            const activeIds = Object.entries(checklistIds).filter(([k, v]) => v).map(([k]) => k);

            // Build Lookup Map
            const idMap = {};
            if (typeof SERVICE_CHECKLISTS !== 'undefined') {
                Object.entries(SERVICE_CHECKLISTS).forEach(([serviceName, categories]) => {
                    Object.entries(categories).forEach(([category, items]) => {
                        items.forEach(item => {
                            const cleanCat = category.replace(/[^a-zA-Z0-9]/g, '');
                            const cleanItemText = item.replace(/<[^>]*>/g, '');
                            const cleanItem = cleanItemText.replace(/[^a-zA-Z0-9]/g, '');
                            const id = cleanCat + cleanItem;
                            idMap[id] = cleanItemText;
                        });
                    });
                });
            }

            return activeIds.map(id => {
                if (idMap[id]) return idMap[id];
                // Fallback
                let readable = id.replace(/([A-Z])/g, ' $1').trim();
                readable = readable.replace(/^(Frame Fork|Handlebar Headset Stem|Brakes|Drivetrain|Wheels Tires)/, '');
                return readable.trim();
            });
        }

        function generateReportBody(job, completedItems, newline) {
            const firstName = job.customer ? job.customer.split(' ')[0] : 'Customer';
            // Add [x] checkbox for text/email
            const itemsList = completedItems.map(k => "[x] " + k).join(newline);
            const body = `Hi ${firstName},${newline}${newline}Here is the service report for your ${job.bike}.${newline}${newline}Service: ${job.service}${newline}Date: ${new Date(job.date).toLocaleDateString()}${newline}${newline}Completed Checks:${newline}${itemsList || 'No specific checks recorded.'}${newline}${newline}Your bike is ready properly maintained!${newline}${newline}- Weeecycle Workshop`;
            return encodeURIComponent(body);
        }

        function downloadPDF(jobId) {
            const doc = new jsPDF();
            // KY Tax Rate
            const TAX_RATE = 0.06;

            const jobs = JSON.parse(localStorage.getItem('workshop_jobs')) || [];
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            // Header
            doc.setFontSize(22);
            doc.setTextColor(255, 137, 27); // Brand Orange
            doc.text("WEEECYCLE WORKSHOP", 20, 20);

            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text("Service Report", 20, 30);

            doc.setLineWidth(0.5);
            doc.line(20, 35, 190, 35);

            // Details
            doc.setFontSize(12);
            doc.text(`Customer: ${job.customer}`, 20, 45);
            doc.text(`Bike: ${job.bike}`, 20, 52);
            doc.text(`Service: ${job.service}`, 20, 59);
            doc.text(`Date: ${new Date(job.date).toLocaleDateString()}`, 140, 45);

            // Checklist
            doc.setFontSize(14);
            doc.text("Completed Checks:", 20, 75);

            const checks = getReadableChecklist(job);
            doc.setFontSize(10);
            let y = 85;
            checks.forEach(check => {
                doc.text(`[x] ${check}`, 20, y);
                y += 6;
            });

            // invoice Calculation
            y += 10;
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            y += 10;

            doc.setFontSize(14);
            doc.text("Invoice", 20, y);
            y += 10;

            const baseServicePrice = SERVICE_PRICES[job.service] || SERVICE_PRICES['A La Carte'] || 0;
            const partsTotal = (job.parts || []).reduce((sum, p) => sum + (parseFloat(p.price) || 0), 0);
            const subtotal = baseServicePrice + partsTotal;
            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;

            doc.setFontSize(10);
            doc.text("Description", 20, y);
            doc.text("Amount", 160, y);
            y += 6;

            // Service
            doc.text(`Service: ${job.service}`, 20, y);
            doc.text(`$${baseServicePrice.toFixed(2)}`, 160, y);
            y += 6;

            // Parts
            if (job.parts && job.parts.length > 0) {
                job.parts.forEach(p => {
                    doc.text(`Part: ${p.desc}`, 20, y);
                    doc.text(`$${parseFloat(p.price).toFixed(2)}`, 160, y);
                    y += 6;
                });
            }

            y += 4;
            doc.line(120, y, 190, y); // separator
            y += 6;

            doc.text("Subtotal:", 120, y);
            doc.text(`$${subtotal.toFixed(2)}`, 160, y);
            y += 6;

            doc.text("KY Tax (6%):", 120, y);
            doc.text(`$${tax.toFixed(2)}`, 160, y);
            y += 8;

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Total Due:", 120, y);
            doc.text(`$${total.toFixed(2)}`, 160, y);

            // Footer
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text("Weeecycle Workshop - Thank you for your business!", 20, 280);

            const safeName = (job.customer || 'customer').replace(/[^a-z0-9]/gi, '_');
            doc.save(`invoice_${safeName}_${job.id}.pdf`);
        }




        // SETTINGS & AUTH LOGIC
        async function changePassword() {
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const msg = document.getElementById('password-msg');

            msg.className = "text-center text-sm hidden";

            if (!currentPass || !newPass) {
                msg.textContent = "Please fill in all fields.";
                msg.classList.remove('hidden');
                msg.classList.add('text-red-500');
                return;
            }

            try {
                // Get current username
                const userStr = localStorage.getItem('workshop_user');
                const username = userStr ? JSON.parse(userStr).username : 'admin';

                const res = await fetch(`${API_URL}/auth/password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, currentPassword: currentPass, newPassword: newPass })
                });
                const data = await res.json();

                if (data.success) {
                    msg.textContent = "Password updated successfully!";
                    msg.classList.remove('hidden');
                    msg.classList.add('text-green-500');
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    setTimeout(() => document.getElementById('settings-modal').close(), 1500);
                } else {
                    msg.textContent = data.error || "Update failed";
                    msg.classList.remove('hidden');
                    msg.classList.add('text-red-500');
                }
            } catch (e) {
                msg.textContent = "Server Connection Error";
                msg.classList.remove('hidden');
                msg.classList.add('text-red-500');
            }
        }

        // MANUAL ADD CONTACT
        function openAddContactModal() {
            document.getElementById('add-contact-name').value = '';
            document.getElementById('add-contact-email').value = '';
            document.getElementById('add-contact-phone').value = '';
            document.getElementById('add-contact-modal').showModal();
        }

        async function saveNewContact() {
            const name = document.getElementById('add-contact-name').value;
            const email = document.getElementById('add-contact-email').value;
            const phone = document.getElementById('add-contact-phone').value;

            if (!name) {
                alert("Name is required");
                return;
            }

            const newContact = {
                id: Date.now().toString(),
                name: name,
                email: email,
                phone: phone,
                lastSeen: new Date().toISOString().split('T')[0],
                count: 0
            };

            await saveContactAPI(newContact);
            document.getElementById('add-contact-modal').close();

            // Show toast
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg z-50 animate-bounce';
            toast.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Contact Added';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);

            renderContacts();
        }

        // START
        init();
    </script>
</body>

</html>